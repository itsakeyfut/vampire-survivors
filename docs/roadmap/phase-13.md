# Phase 13: 宝箱システム

## フェーズ概要

**ステータス**: 🔲 未着手
**推定工数**: 3-4時間
**依存関係**: Phase 8（武器進化が必要）

### 目的
マップ上に宝箱をスポーンし、プレイヤーが開封時にランダムな報酬（武器進化・アップグレード・HP回復・ゴールド）を受け取れるシステムを実装する。

---

## タスクリスト

### タスク 13.1: 宝箱エンティティの定義

**優先度**: P0
**推定工数**: 0.5時間
**ラベル**: task, phase-13

**説明**:
`Treasure` コンポーネントと宝箱のスポーン関数を実装する。

**受け入れ基準**:
- [ ] `Treasure` コンポーネントと `TreasureContent` enumが定義されている
- [ ] 宝箱がプレースホルダースプライト（黄色の宝箱形）で表示される
- [ ] `CircleCollider { radius: 20.0 }` を持つ

---

### タスク 13.2: 宝箱スポーンシステム

**優先度**: P0
**推定工数**: 0.5時間
**ラベル**: task, phase-13

**説明**:
3分ごとに画面内のランダムな位置に宝箱をスポーンする。

**受け入れ基準**:
- [ ] `TreasureSpawner` リソースが 180秒間隔でスポーンをトリガーする
- [ ] スポーン位置はカメラ（プレイヤー）を中心とした画面内の適切な位置
- [ ] 宝箱は消えない（プレイヤーが開けるまで永続）

---

### タスク 13.3: プレイヤーと宝箱の接触判定

**優先度**: P0
**推定工数**: 0.5時間
**ラベル**: task, phase-13

**説明**:
プレイヤーが宝箱の衝突範囲内に入ったら自動的に宝箱を開封する。

**受け入れ基準**:
- [ ] プレイヤーが宝箱に近づくと自動開封される
- [ ] `TreasureOpenedEvent` が送信される
- [ ] 開封済み宝箱は削除される

---

### タスク 13.4: 宝箱の内容ロジック

**優先度**: P0
**推定工数**: 1時間
**ラベル**: task, phase-13

**説明**:
宝箱開封時の内容を決定するロジックを実装する。武器進化を最優先で確認する。

**受け入れ基準**:
- [ ] 武器進化可能な状態なら武器進化を優先発動する
- [ ] 進化なしの場合、ランダムで次のいずれかが発動する:
  - ランダムアップグレード（所持武器/パッシブのいずれかを1レベルアップ）
  - HP回復（最大HPの30%回復）
  - ゴールド獲得（50〜200G）

**実装ガイド**:
```rust
pub fn determine_treasure_content(
    weapon_inventory: &WeaponInventory,
    passive_inventory: &PassiveInventory,
    player_stats: &PlayerStats,
    rng: &mut impl Rng,
) -> TreasureContent {
    // 武器進化チェック（優先度最高）
    for weapon_state in &weapon_inventory.weapons {
        if let Some(evolved_weapon) = can_evolve_weapon(weapon_state, passive_inventory) {
            return TreasureContent::WeaponEvolution(evolved_weapon);
        }
    }

    // ランダム内容
    match rng.gen_range(0..3) {
        0 => TreasureContent::RandomUpgrade,
        1 => TreasureContent::HpRestore(0.3), // 30%回復
        _ => TreasureContent::Gold(rng.gen_range(50..=200)),
    }
}
```

---

### タスク 13.5: 宝箱内容の適用

**優先度**: P0
**推定工数**: 1時間
**ラベル**: task, phase-13

**説明**:
`TreasureOpenedEvent` を受け取り、内容に応じた処理を実行する。

**受け入れ基準**:
- [ ] 武器進化の場合、対象武器の `weapon_type` と `evolved` フラグを更新する
- [ ] ランダムアップグレードの場合、所持武器/パッシブからランダムに1つをレベルアップ
- [ ] HP回復の場合、プレイヤーのHPを最大HPの30%分回復（最大HP超えない）
- [ ] ゴールドの場合、`GameData.gold_earned` と `MetaProgress.total_gold` に加算
- [ ] 各ケースに対応したSFXが再生される（Phase 15で実装）

---

### タスク 13.6: 宝箱の視覚的演出

**優先度**: P2
**推定工数**: 0.5時間
**ラベル**: task, phase-13, polish

**説明**:
宝箱がマップ上に出現したことをプレイヤーに知らせる演出を追加する。

**受け入れ基準**:
- [ ] 宝箱スポーン時に短時間点滅する
- [ ] 宝箱アイコンがプレイヤー近くになるとハイライトされる（オプション）

---

## フェーズ検証

### 検証項目
- [ ] 3分ごとに宝箱がマップ上に出現する
- [ ] プレイヤーが宝箱に近づくと自動開封される
- [ ] 武器進化条件を満たしている場合、宝箱で進化が発動する
- [ ] HP回復・ゴールド獲得・ランダムアップグレードが正しく機能する

## 次のフェーズ

Phase 13 完了 → 次は **Phase 14: メタ進行** に進む
